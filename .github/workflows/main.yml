# 工作流名称
name: Build Python Wheels

# 触发工作流的事件
on:
  # 当有代码推送到 main 分支时触发
  push:
    branches:
      - main
      - master
      - python_binding # 也可以指定在 python_binding 分支上触发
  # 允许在 GitHub Actions 页面手动触发
  workflow_dispatch:

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }} for Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        python-version: ['3.8', '3.11']
    steps:
      - name: Checkout 'python_binding' branch
        uses: actions/checkout@v4
        with:
          ref: 'python_binding'
          submodules: 'recursive'
      # --- 修改后的步骤 ---
      - name: Install system dependencies with retry
        # 使用 shell 的循环来实现简单的重试逻辑
        run: |
          for i in 1 2 3; do
            # 设置 DEBIAN_FRONTEND=noninteractive 防止任何可能的交互式提示
            # -yqq 选项表示自动同意且减少不必要的输出
            sudo DEBIAN_FRONTEND=noninteractive apt-get update && \
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -yqq build-essential cmake libopencv-dev && \
            echo "System dependencies installed successfully." && exit 0
            echo "Attempt $i failed. Retrying in 5 seconds..."
            sleep 5
          done
          echo "Failed to install system dependencies after 3 attempts."
          exit 1
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install Python build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install wheel setuptools pybind11 numpy opencv-python
      - name: Build wheel
        run: python -m pip wheel . --wheel-dir dist/
      - name: Upload wheels as artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-wheels-${{ matrix.os }}-py${{ matrix.python-version }}
          path: ./dist/*.whl
